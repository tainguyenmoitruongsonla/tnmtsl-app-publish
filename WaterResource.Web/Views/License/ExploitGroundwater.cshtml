@using WaterResource.Service;
@{
    ViewBag.Title = "Hệ thống quản lý cơ sở dữ liệu cấp phép khai thác sử dụng nước mặt";
    UserRightService _service = new UserRightService();
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@if (_service.IsViewAction("giay-phep", User.Identity.Name, "VIEW"))
{
    <style>
        .leaflet-popup-content {
            overflow-y: auto;
        }
    </style>
    <link href="~/Assets/leaflet/leaflet.css" rel="stylesheet" />
    <script src="~/Assets/leaflet/leaflet.js"></script>
    <script src="~/Assets/leaflet/L.KML.js"></script>
    <!-- Load Esri Leaflet from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/esri-leaflet/2.0.4/esri-leaflet.js"></script>

    <!-- Load Esri Leaflet Vector from CDN -->
    <script src="https://unpkg.com/esri-leaflet-vector@3.1.3/dist/esri-leaflet-vector.js" crossorigin=""></script>
    <script src="~/Assets/leaflet/leaflet-bing-layer.js"></script>
    <script src="~/Assets/leaflet/Bing.js"></script>
    <input type="hidden" id="tbxUsername" value="@User.Identity.Name" />
    <div ng-controller="myCntrl as demo">
        <script src="~/Scripts/License/Controller.js"></script>
        @Html.Partial("ImportServiceJs")
        <!-- Main content -->
        <section class="content px-0">
            <div class="row m-0">
                <section class="col-12 p-0">
                    <div class="col-md-12 p-0">
                        <div class="p-0 bg-white">
                            <div class="row m-0">
                                <div class="col-12 col-md-3 p-0 countLicense">
                                    <div class="col-12">
                                        <div class="col-12 py-1 d-flex justify-content-center text-center border-bottom">
                                            <div class="col-9 text-left p-0">
                                                <p class="font-weight-bold m-0 font-14">Tổng số giấy phép</p>
                                                <p class="font-18 m-0 font-weight-bold text-danger"> <span ng-bind-html="CountLicenses.exploidGroundwater[0] - 0"></span> </p>
                                            </div>
                                            <img src="~/LocalFiles/images/QUAN_LY_CAP_PHEP/CONG_TRINH/licensing.png" class="p-0 hydroelectric-sub-icon border-secondary my-auto mx-2" alt="giay-phep" />
                                        </div>
                                        <div class="col-12 py-1 d-flex justify-content-center text-center border-bottom">
                                            <div class="col-9 text-left p-0">
                                                <p class="font-weight-bold m-0 font-14">Giấy phép sắp hết hiệu lực</p>
                                                <p class="font-18 m-0 font-weight-bold text-danger"> <span ng-bind-html="CountLicenses.exploidGroundwater[2] - 0"></span> / <span ng-bind-html="CountLicenses.exploidGroundwater[0] - 0"></span></p>
                                            </div>
                                            <img src="~/LocalFiles/images/QUAN_LY_CAP_PHEP/CONG_TRINH/licensing-2.png" class="p-0 hydroelectric-sub-icon border-secondary my-auto mx-2" alt="giay-phep-2" />
                                        </div>
                                        <div class="col-12 py-1 d-flex justify-content-center text-center border-bottom">
                                            <div class="col-9 text-left p-0">
                                                <p class="font-weight-bold m-0 font-14">Giấy phép hết hiệu lực</p>
                                                <p class="font-18 m-0 font-weight-bold text-danger"> <span ng-bind-html="CountLicenses.exploidGroundwater[1] - 0"></span> / <span ng-bind-html="CountLicenses.exploidGroundwater[0] - 0"></span></p>
                                            </div>
                                            <img src="~/LocalFiles/images/QUAN_LY_CAP_PHEP/CONG_TRINH/licensing-3.png" class="p-0 hydroelectric-sub-icon border-secondary my-auto mx-2" alt="giay-phep-3" />
                                        </div>
                                        <div class="col-12 py-1 d-flex justify-content-center text-center border-bottom mb-lg-3">
                                            <div class="col-9 text-left p-0">
                                                <p class="font-weight-bold m-0 font-14">Đã bị thu hồi</p>
                                                <p class="font-18 m-0 font-weight-bold text-danger">  <span ng-bind-html="CountLicenses.exploidGroundwater[5] - 0"></span> / <span ng-bind-html="CountLicenses.exploidGroundwater[0] - 0"></span></p>
                                            </div>
                                            <img src="~/LocalFiles/images/QUAN_LY_CAP_PHEP/CONG_TRINH/expire.png" class="p-0 hydroelectric-sub-icon border-secondary my-auto mx-2" alt="het-han" />
                                        </div>
                                    </div>
                                </div>
                                <!-- MAP -->
                                <div class="col-12 col-md-9">
                                    <div style="width: 100%; height: 45vh">
                                        <select id="basemaps" class="form-select switch-basemap" aria-label="Default select example">
                                            <option value="Imagery">Bản đồ vệ tinh</option>
                                            <option value="Topographic">Bản đồ địa hình</option>
                                            <option value="Streets">Bản đồ đường</option>
                                            <option value="Gray">Bản đồ xám</option>
                                        </select>
                                        <div class="common-map" id="Map"></div>
                                    </div>
                                </div>
                                <!-- END MAP -->
                            </div>
                            <div class="col-12">
                                @Html.Partial("_search")

                                <div class="table-responsive wrapper-sticky">
                                    <table class="table no-margin table-hover table-bordered" id="table-show-license">
                                        <thead class="custom-table-thead">
                                            <tr class="text-center">
                                                <th rowspan="3" class="text-nowrap sticky-col start-col">Số GP</th>
                                                <th colspan="8" class="text-nowrap">Thông tin giấy phép</th>
                                                <th colspan="2" class="text-nowrap">Thông tin giấy phép cũ</th>
                                                <th colspan="5" class="text-nowrap">Thông tin công trình</th>
                                                <th colspan="14" class="text-nowrap">Thông số công trình</th>
                                                <th colspan="3" class="">Tiền cấp quyền</th>
                                                <th rowspan="3" class=" sticky-col end-col" style="width: 90px;">Thao tác</th>
                                            </tr>
                                            <tr class="text-center">
                                                <!-- License -->
                                                <th rowspan="2" class="text-nowrap">Hiệu lực GP</th>
                                                <th rowspan="2" class="text-nowrap">Ngày ký</th>
                                                <th rowspan="2" class="text-nowrap">Thời hạn <br /> giấy phép</th>
                                                <th rowspan="2" class="text-nowrap">Ngày bắt đầu <br /> hiệu lực</th>
                                                <th rowspan="2" class="text-nowrap">Ngày kết thúc <br /> hiệu lực</th>
                                                <th rowspan="2" class="text-nowrap">Tên chủ giấy phép</th>
                                                <th rowspan="2" class="text-nowrap">Địa chỉ chủ giấy phép</th>
                                                <th rowspan="2" class="text-nowrap">Loại hình <br /> cấp phép</th>
                                                <!-- Old license -->
                                                <th rowspan="2" class="text-nowrap">Số giấy phép cũ</th>
                                                <th rowspan="2" class="text-nowrap">Ngày ký <br /> giấy phép cũ</th>
                                                <!-- Construction -->
                                                <th rowspan="2" class="text-nowrap">Tên công trình</th>
                                                <th rowspan="2" class="text-nowrap">Địa điểm công trình</th>
                                                <th rowspan="2" class="text-nowrap">Thời gian <br /> bắt đầu VH</th>
                                                <th rowspan="2" class="text-nowrap">Xã</th>
                                                <th rowspan="2" class="text-nowrap">Huyện</th>
                                                <th rowspan="2" class="text-nowrap text-center">Thông tin hạng mục</th>
                                                <!-- TSCT -->
                                                <th rowspan="2" class="text-nowrap">Q<sub>KT</sub> <br /> (m<sup>3</sup>/<sub>ngày đêm</sub>)</th>
                                                <th rowspan="2" class="text-nowrap">Chế độ KT <br /> (Giờ/ngày đêm)</th>
                                                <th colspan="2" class="text-nowrap">h</th>
                                                <th colspan="2" class="text-nowrap">h<sub>đoạn thu nước</sub></th>
                                                <th colspan="2" class="text-nowrap">h<sub>đặt ống</sub></th>
                                                <th rowspan="2" class="text-nowrap">H<sub>hạ thấp</sub>(m)</th>
                                                <th rowspan="2" class="text-nowrap">Tổng số <br /> giếng KT</th>
                                                <th rowspan="2" class="text-nowrap">Q<sub>theo mục đích KTSD</sub> <br /> (m<sup>3</sup>/<sub>ngày đêm</sub>)</th>
                                                <th rowspan="2" class="text-nowrap">Tầng chứa nước</th>
                                                <th rowspan="2" class="text-nowrap">Tổng Q<sub>KTSD</sub></th>
                                                <!-- LicenseFee -->
                                                <th rowspan="2" class="">Số quyết định</th>
                                                <th rowspan="2" class="">Ngày ký </th>
                                                <th rowspan="2" class="">Tổng tiền(VNĐ)</th>
                                            </tr>
                                            <tr>
                                                <th class="">H<sub>tĩnh</sub> (m)</th>
                                                <th class="">H<sub>động</sub> (m)</th>
                                                <th class="">Từ(m)</th>
                                                <th class="">Đến(m)</th>
                                                <th class="">Từ(m)</th>
                                                <th class="">Đến(m)</th>
                                            </tr>
                                        </thead>
                                        <tbody class="custom-table-tbody">
                                            <tr ng-repeat="item in Licenses">
                                                <td class="sticky-col start-col align-middle"><span ng-click="openAsideFileLicense(item.TypeOfConstructionId, item.LicenseFile)" class="text-primary text-nowrap" ng-bind="item.LicenseNumber"></span></td>
                                                <td class="align-middle" ng-bind-html="CheckLicenseEffect(item)"></td>
                                                <td class="align-middle" ng-bind="item.SignDate | date:'dd/MM/yyyy'"></td>
                                                <td class="align-middle" ng-bind="item.Duration"></td>
                                                <td class="align-middle" ng-bind="item.IssueDate | date:'dd/MM/yyyy'"></td>
                                                <td class="align-middle" ng-bind="item.ExpireDate | date:'dd/MM/yyyy'"></td>
                                                <td class="align-middle" ng-bind="item.Business.Name"></td>
                                                <td class="align-middle" ng-bind="item.Business.Address"></td>
                                                <td class="align-middle" ng-bind="item.LicenseTypeName"></td>
                                                <td class="align-middle" ng-bind="item.OldLicense.LicenseNumber"></td>
                                                <td class="align-middle" ng-bind="item.OldLicense.SignDate"></td>
                                                <td class="align-middle" ng-bind="item.Construction.ConstructionName"></td>
                                                <td class="align-middle" ng-bind="item.Construction.ConstructionLocation"></td>
                                                <td class="align-middle" ng-bind="item.Construction.StartDate"></td>
                                                <td class="align-middle" ng-bind="item.Location.CommuneName"></td>
                                                <td class="align-middle" ng-bind="item.Location.DistrictName"></td>
                                                <td class="align-middle">
                                                    <div ng-repeat="i in item.Construction.ConstructionItems">
                                                        + Số hiệu: <span ng-bind="i.Name"></span>: &nbsp; X=<span ng-bind="i.X"></span> - Y=<span ng-bind="i.Y"></span>
                                                    </div>
                                                </td>
                                                <td class="align-middle">
                                                    <div ng-repeat="i in item.Construction.ConstructionItems">
                                                        <span ng-bind="i.AmountWaterExploited"></span>
                                                    </div>
                                                </td>
                                                <td class="align-middle">
                                                    <div ng-repeat="i in item.Construction.ConstructionItems">
                                                        <span ng-bind="i.MiningMode"></span>
                                                    </div>
                                                </td>
                                                <td class="align-middle">
                                                    <div ng-repeat="i in item.Construction.ConstructionItems">
                                                        <span ng-bind="i.StaticWL"></span>
                                                    </div>
                                                </td>
                                                <td class="align-middle">
                                                    <div ng-repeat="i in item.Construction.ConstructionItems">
                                                        <span ng-bind="i.DynamicWL"></span>
                                                    </div>
                                                </td>
                                                <td class="align-middle">
                                                    <div ng-repeat="i in item.Construction.ConstructionItems">
                                                        <span ng-bind="i.WaterDepthFrom"></span>
                                                    </div>
                                                </td>
                                                <td class="align-middle">
                                                    <div ng-repeat="i in item.Construction.ConstructionItems">
                                                        <span ng-bind="i.WaterDepthTo"></span>
                                                    </div>
                                                </td>
                                                <td class="align-middle">
                                                    <div ng-repeat="i in item.Construction.ConstructionItems">
                                                        <span ng-bind="i.DepthFilterTubeFrom"></span>
                                                    </div>
                                                </td>
                                                <td class="align-middle">
                                                    <div ng-repeat="i in item.Construction.ConstructionItems">
                                                        <span ng-bind="i.DepthFilterTubeTo"></span>
                                                    </div>
                                                </td>
                                                <td class="align-middle" ng-bind="item.Construction.LowWL"></td>
                                                <td class="align-middle" ng-bind="item.Construction.NumberMiningWells"></td>
                                                <td class="align-middle">
                                                    <div ng-repeat="i in item.MiningPurposes">
                                                        <span ng-bind="i.Purpose"></span>: &nbsp; <span ng-bind="i.WaterExploitedFlow"></span>
                                                    </div>
                                                </td>
                                                <td class="align-middle" ng-bind="item.Construction.AquiferName"></td>
                                                <td class="align-middle" ng-bind="item.Construction.AmountWaterExploited"></td>
                                                <!--TCQ-->
                                                <td>
                                                    <div ng-repeat="licFee in item.LicenseFees">
                                                        <span ng-click="openLicenseFeeFile(licFee)" class="text-primary text-nowrap" ng-bind-html="licFee.LicenseFeeNumber"></span>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div ng-repeat="licFee in item.LicenseFees">
                                                        <span ng-bind-html="licFee.SignDate | date:'dd/MM/yyyy'"></span>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div ng-repeat="licFee in item.LicenseFees">
                                                        <span ng-bind-html="licFee.TotalMoney | number : fractionSize"></span>
                                                    </div>
                                                </td>
                                                <td class="align-middle sticky-col end-col">
                                                    <div class="d-flex">
                                                        @if (_service.IsViewAction("giay-phep", User.Identity.Name, "EDIT"))
                                                        {
                                                            <button style="padding-left:10px" class="btn btn-link" ng-click="EDIT(item,'formCreateLicense')" title="Sửa">
                                                                <i class="fa fa-edit" aria-hidden="true"></i>
                                                            </button>
                                                        }
                                                        @if (_service.IsViewAction("/giay-phep", User.Identity.Name, "DELETE"))
                                                        {
                                                            <button style="padding-left:10px" class="btn text-red" ng-click="DELETE(item,1)" title="Xóa giấy phép">
                                                                <i class="fa-solid fa-trash-can"></i>
                                                            </button>
                                                        }
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <!-- pagination -->
                                @Html.Partial("_pagination")
                            </div>
                        </div>
                    </div>
                </section>
            </div>
            <table class="d-none" id="excel-export">
                <thead>
                    <tr>
                        <th>Số giấy phép</th>
                        <th>Ngày ký</th>
                        <th>Thời hạn cấp phép</th>
                        <th>Ngày bắt đầu hiệu lực</th>
                        <th>Ngày kết thúc hiệu lực</th>
                        <th>Tên chủ giấy phép</th>
                        <th>Địa chỉ chủ giấy phép</th>
                        <th>Loại hình cấp phép</th>
                        <th>Số giấy phép cũ</th>
                        <th>Ngày ký số giấy phép cũ</th>
                        <th>Tên công trình</th>
                        <th>Địa điểm công trình</th>
                        <th>Mã tỉnh</th>
                        <th>Mã huyện</th>
                        <th>Mã xã</th>
                        <th>Số hiệu giếng</th>
                        <th>X</th>
                        <th>Y</th>
                        <th>Lưu lượng khai thác</th>
                        <th>Chiều sâu mực nước tĩnh</th>
                        <th>Chiều sâu mực nước động</th>
                        <th>Tầng chứa nước (giếng)</th>
                        <th>Tổng số giếng khai thác</th>
                        <th>Thời gian bắt đầu vận hành</th>
                        <th>Lưu lượng theo mục đích KTSD</th>
                        <th>Tầng chứa nước</th>
                        <th>Tổng lưu lượng KTSD</th>
                        <th>Số quyết định TCQ</th>
                        <th>Ngày ký quyết định TCQ</th>
                        <th>Tổng tiền</th>
                        <th>Số điểm giếng </th>
                        <th>Số điểm hạng mục</th>
                    </tr>
                </thead>
                <tbody>
                    <tr ng-repeat="item in ExcelLicense">
                        <td ng-bind="item.LicenseNumber"></td>
                        <td ng-bind="item.SignDate | date:'dd/MM/yyyy'"></td>
                        <td ng-bind="item.Duration"></td>
                        <td ng-bind="item.IssueDate | date:'dd/MM/yyyy'"></td>
                        <td ng-bind="item.ExpireDate | date:'dd/MM/yyyy'"></td>
                        <td ng-bind="item.Business.Name"></td>
                        <td ng-bind="item.Business.Address"></td>
                        <td ng-bind="item.LicenseTypeName"></td>
                        <td ng-bind="item.OldLicense.LicenseNumber"></td>
                        <td ng-bind="item.OldLicense.SignDate | date:'dd/MM/yyyy'"></td>
                        <td ng-bind="item.Construction.ConstructionName"></td>
                        <td ng-bind="item.Construction.ConstructionLocation"></td>
                        <td ng-bind="item.Location.CityId"></td>
                        <td ng-bind="item.Location.DistrictId"></td>
                        <td ng-bind="item.Location.CommuneId"></td>
                        <td ng-bind="item.Construction.ConstructionItems[0].Name"></td>
                        <td ng-bind="item.Construction.ConstructionItems[0].X"></td>
                        <td ng-bind="item.Construction.ConstructionItems[0].Y"></td>
                        <td ng-bind="item.Construction.WaterSupplyFlow"></td>
                        <td ng-bind="item.Construction.StaticWL"></td>
                        <td ng-bind="item.Construction.DynamicWL"></td>
                        <td ng-bind="item.Construction.MiningAquifer"></td>
                        <td ng-bind="item.Construction.NumberMiningWells"></td>
                        <td ng-bind="item.Construction.StartDate"></td>
                        <td ng-bind="item.Construction.MinimumFlow"></td>
                        <td ng-bind="item.Construction.MiningAquifer"></td>
                        <td ng-bind="item.Construction.AmountWaterExploited"></td>
                        <td ng-bind="item.LicenseFee.DecisionNumber"></td>
                        <td ng-bind="item.LicenseFee.SignDate | date:'dd/MM/yyyy'"></td>
                        <td ng-bind="item.LicenseFee.TotalMoney | number"></td>
                        <td ng-bind="item.Construction.ConstructionItems.length"></td>
                        <td ng-bind="item.Construction.ConstructionItems.length"></td>
                    </tr>
                </tbody>
            </table>

            @Html.Partial("ViewFilePDF")
            @Html.Partial("_formCreateLicense")
            @Html.Partial("_addBusiness")
            @Html.Partial("_viewLicense")
            @Html.Partial("_ModalConstruction/_ExploitGroundwater")
        </section>
        <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->
}
else
{
    @Html.Partial("_401")
}